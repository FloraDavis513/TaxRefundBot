#!/usr/bin/python
# -*- coding: utf8 -*-

import telebot
import telegram_config
from telebot import types
import re
from datetime import datetime


 
bot = telebot.TeleBot(telegram_config.TOKEN)

last_income = 0
prev_prev_last_income = 0
prev_prev_prev_last_income = 0
invest_duration = 0
property_cost = 0

@bot.message_handler(commands=['start'])
def welcome(message):
    with open(f'log.txt', 'a', encoding='utf-8') as g:
        print(f'{str(message.from_user.username)}\n{str(message.from_user.first_name)}\n{str(message.from_user.last_name)}\n{str(message.from_user.id)}\n\n', file=g)
    bot.send_message(message.chat.id, telegram_config.WELCOME_MESSAGE)

@bot.message_handler(commands=['stop'])
def stop_info(message):
    bot.send_message(message.chat.id, telegram_config.STOP_MESSAGE)

@bot.message_handler(commands=['help'])
def help_info(message):
    bot.send_message(message.chat.id, telegram_config.COMMAND_LIST)






@bot.message_handler(commands=['feedback'])
def feedback(message):
    bot.register_next_step_handler(message, send_feedback)
    bot.send_message(message.chat.id, '''–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –æ—Ç–∑—ã–≤''')

def send_feedback(message):
    if message.text != '':
        bot.send_message(503168284, f'''–§–∏–¥–±–µ–∫ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {str(message.from_user.first_name)} {str(message.from_user.last_name)}({str(message.from_user.id)}) –ø–æ–ª—É—á–µ–Ω:''')
        bot.send_message(503168284, message.text)
        bot.send_message(message.chat.id, '''–§–∏–¥–±–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω''')

@bot.message_handler(commands=['instruction'])
def instruction(message):
    bot.send_message(message.chat.id, telegram_config.INSTRUCTION_MESSAGE)
    doc = open('c:/Users/Alex/Desktop/Bot/TaxRefundBot/test_file.txt', 'rb')
    bot.send_document(message.chat.id, doc)







@bot.message_handler(commands=['test'])
def test(message):
    markup_resident = types.InlineKeyboardMarkup(row_width=2)
    yes_button = types.InlineKeyboardButton("–î–∞", callback_data='test_resident')
    no_button = types.InlineKeyboardButton("–ù–µ—Ç", callback_data='test_not_resident')
    markup_resident.add(yes_button, no_button)
    bot.send_message(message.chat.id, telegram_config.IS_RESIDENT, reply_markup=markup_resident)

@bot.message_handler(commands=['standard'])
def standard(message):
    bot.send_message(message.chat.id, telegram_config.STANDARD_MESSAGE)

@bot.message_handler(commands=['get_standard'])
def get_standard(message):
    bot.send_message(message.chat.id, telegram_config.GET_STANDARD_MESSAGE)

@bot.message_handler(commands=['property'])
def property(message):
    bot.send_message(message.chat.id, telegram_config.PROPERTY_MESSAGE)

@bot.message_handler(commands=['get_property'])
def get_property(message):
    bot.send_message(message.chat.id, telegram_config.GET_PROPERTY_MESSAGE)

@bot.message_handler(commands=['investment'])
def investment(message):
    bot.send_message(message.chat.id, telegram_config.INVESTMENT_MESSAGE)

@bot.message_handler(commands=['get_investment_type_A'])
def investment_type_A(message):
    bot.send_message(message.chat.id, telegram_config.INVESTMENT_MESSAGE_A)

@bot.message_handler(commands=['social'])
def instruction(message):
    bot.send_message(message.chat.id, telegram_config.SOCIAL_MESSAGE_1)
    bot.send_message(message.chat.id, telegram_config.SOCIAL_MESSAGE_2)

@bot.message_handler(commands=['get_social'])
def get_social(message):
    bot.send_message(message.chat.id, telegram_config.GET_SOCIAL_MESSAGE)




@bot.message_handler(commands=['calculate'])
def calculate_info(message):
    bot.register_next_step_handler(message, get_last_income)
    bot.send_message(message.chat.id, '''üìå –í–≤–µ–¥–∏ —Å–≤–æ–π –¥–æ—Ö–æ–¥ –∑–∞ –ø—Ä–æ—à–ª—ã–π –≥–æ–¥: ''')

def get_last_income(message):
    if not re.match(r'\d+$', message.text):
        bot.send_message(message.chat.id, '''–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ —Å–≤–æ–π –¥–æ—Ö–æ–¥ –∑–∞ –ø—Ä–æ—à–ª—ã–π –≥–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: *–î–æ—Ö–æ–¥*''')
        bot.register_next_step_handler(message, get_last_income)
    else:
        global last_income
        last_income = int(message.text)
        bot.send_message(message.chat.id, '''üìå –ö–∞–∫–æ–π –≤—ã—á–µ—Ç —Ö–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å? ''')
        markup_calculate = types.InlineKeyboardMarkup(row_width=3)
        social_button = types.InlineKeyboardButton("–°–æ—Ü–∏–∞–ª—å–Ω—ã–π", callback_data='calculate_social')
        invest_button = types.InlineKeyboardButton("–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π", callback_data='calculate_invest')
        property_button = types.InlineKeyboardButton("–ò–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π", callback_data='calculate_property')
        markup_calculate.add(social_button, invest_button, property_button)
        bot.send_message(message.chat.id, '''–í–∏–¥—ã –Ω–∞–ª–æ–≥–æ–≤—ã—Ö –≤—ã—á–µ—Ç–æ–≤: ''', reply_markup=markup_calculate)

@bot.callback_query_handler(func=lambda call: call.data.startswith('test'))
def callback_inline(call):
    try:
        if call.message:
            if call.data == 'test_resident':
                markup_answer = types.InlineKeyboardMarkup(row_width=1)
                ans_button = types.InlineKeyboardButton("–î–∞", callback_data='1')
                markup_answer.add(ans_button)
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text=telegram_config.IS_RESIDENT,
                reply_markup=markup_answer)
                markup_income = types.InlineKeyboardMarkup(row_width=2)
                yes_button = types.InlineKeyboardButton("–î–∞", callback_data='test_has_income')
                no_button = types.InlineKeyboardButton("–ù–µ—Ç", callback_data='test_not_income')
                markup_income.add(yes_button, no_button)
                bot.send_message(call.message.chat.id, telegram_config.INCOME_MESSAGE, reply_markup=markup_income)
            elif call.data == 'test_not_resident':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text=telegram_config.IS_RESIDENT + '‚ùå',
                reply_markup=None)
                markup_restart = types.InlineKeyboardMarkup(row_width=1)
                restart_button = types.InlineKeyboardButton("–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç", callback_data='test_restart_1')
                markup_restart.add(restart_button)
                bot.send_message(call.message.chat.id, telegram_config.REJECT_MESSAGE_1, reply_markup=markup_restart)
            elif call.data == 'test_has_income':
                bot.send_message(call.message.chat.id, '–î–∞')
                bot.send_message(call.message.chat.id, telegram_config.REFUND_MESSAGE_INFO)
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text=telegram_config.INCOME_MESSAGE,
                reply_markup=None)
            elif call.data == 'test_not_income':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text=telegram_config.INCOME_MESSAGE + '‚ùå',
                reply_markup=None)
                markup_restart = types.InlineKeyboardMarkup(row_width=1)
                restart_button = types.InlineKeyboardButton("–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç", callback_data='test_restart_2')
                markup_restart.add(restart_button)
                bot.send_message(call.message.chat.id, telegram_config.REJECT_MESSAGE_2, reply_markup=markup_restart)
            elif call.data == 'test_restart_1':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text=telegram_config.REJECT_MESSAGE_1,
                reply_markup=None)
                markup_resident = types.InlineKeyboardMarkup(row_width=2)
                yes_button = types.InlineKeyboardButton("–î–∞", callback_data='test_resident')
                no_button = types.InlineKeyboardButton("–ù–µ—Ç", callback_data='test_not_resident')
                markup_resident.add(yes_button, no_button)
                bot.send_message(call.message.chat.id, telegram_config.IS_RESIDENT, reply_markup=markup_resident)
            elif call.data == 'test_restart_2':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text=telegram_config.REJECT_MESSAGE_2,
                reply_markup=None)
                markup_resident = types.InlineKeyboardMarkup(row_width=2)
                yes_button = types.InlineKeyboardButton("–î–∞", callback_data='test_resident')
                no_button = types.InlineKeyboardButton("–ù–µ—Ç", callback_data='test_not_resident')
                markup_resident.add(yes_button, no_button)
                bot.send_message(call.message.chat.id, telegram_config.IS_RESIDENT, reply_markup=markup_resident)
    except Exception as e:
        print(repr(e))
    return True

@bot.callback_query_handler(func=lambda call: call.data.startswith('calculate'))
def callback_inline(call):
    try:
        if call.message:
            if call.data == 'calculate_social':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''–†–∞—Å—á–µ—Ç —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –≤—ã—á–µ—Ç–æ–≤
                ''', reply_markup=None)
                markup_calculate_social = types.InlineKeyboardMarkup(row_width=2)
                charity_button = types.InlineKeyboardButton("–ù–∞ –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", callback_data='social_charity')
                education_button = types.InlineKeyboardButton("–ù–∞ –æ–±—É—á–µ–Ω–∏–µ", callback_data='social_education')
                medicine_button = types.InlineKeyboardButton("–ù–∞ –ª–µ—á–µ–Ω–∏–µ –∏ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞", callback_data='social_medicine')
                insurance_button = types.InlineKeyboardButton("–ù–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ", callback_data='social_insurance')
                qualification_button = types.InlineKeyboardButton("–ù–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—É—é –æ—Ü–µ–Ω–∫—É –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏", callback_data='social_qualification')
                markup_calculate_social.add(charity_button, education_button, medicine_button, insurance_button, qualification_button)
                bot.send_message(call.message.chat.id, '''üìå –ö–∞–∫–æ–π –≤–∏–¥ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –≤—ã—á–µ—Ç–∞ —É —Ç–µ–±—è?''', reply_markup=markup_calculate_social)
            elif call.data == 'calculate_invest':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''–†–∞—Å—á–µ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã—Ö –≤—ã—á–µ—Ç–æ–≤''',
                reply_markup=None)
                markup_calculate_invest = types.InlineKeyboardMarkup(row_width=2)
                type_a_button = types.InlineKeyboardButton("–õ—å–≥–æ—Ç–∞ —Ç–∏–ø–∞ –ê", callback_data='invest_a')
                type_b_button = types.InlineKeyboardButton("–õ—å–≥–æ—Ç–∞ —Ç–∏–ø–∞ –ë", callback_data='invest_b')
                markup_calculate_invest.add(type_a_button, type_b_button)
                bot.send_message(call.message.chat.id, '''üìå –ö–∞–∫–æ–π —Ç–∏–ø –ª—å–≥–æ—Ç –ø–æ –ò–ò–° —É —Ç–µ–±—è? ''', reply_markup=markup_calculate_invest)
            elif call.data == 'calculate_property':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''–†–∞—Å—á–µ—Ç –∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã—á–µ—Ç–æ–≤''',
                reply_markup=None)
                bot.send_message(call.message.chat.id, '''üìå–í–≤–µ–¥–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–Ω–æ–≥–æ –∏–ª–∏ –ø—Ä–æ–¥–∞–Ω–Ω–æ–≥–æ –∂–∏–ª—å—è''')
                bot.register_next_step_handler(call.message, get_property_cost)
    except Exception as e:
        print(repr(e))
    return True

@bot.callback_query_handler(func=lambda call: call.data.startswith('social'))
def callback_inline(call):
    try:
        if call.message:
            if call.data == 'social_charity':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå –ö–∞–∫–æ–π –≤–∏–¥ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –≤—ã—á–µ—Ç–∞ —É —Ç–µ–±—è?''',
                reply_markup=None)
                bot.send_message(call.message.chat.id, '''üìå –°–∫–æ–ª—å–∫–æ —Ç—ã –æ—Ç–¥–∞–ª –Ω–∞ –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —ç—Ç–æ–º –≥–æ–¥—É? ''')
                bot.register_next_step_handler(call.message, get_last_charity)
            if call.data == 'social_education':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå –ö–∞–∫–æ–π –≤–∏–¥ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –≤—ã—á–µ—Ç–∞ —É —Ç–µ–±—è?''',
                reply_markup=None)
                markup_education = types.InlineKeyboardMarkup(row_width=2)
                own_button = types.InlineKeyboardButton("–°–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ", callback_data='social_education_own')
                child_button = types.InlineKeyboardButton("–ù–∞ –æ–±—É—á–µ–Ω–∏–µ —Å–≤–æ–µ–≥–æ —Ä–µ–±–µ–Ω–∫–∞(–ø–æ–¥–ø–µ—á—ë–Ω–Ω–æ–≥–æ)", callback_data='social_education_child')
                markup_education.add(own_button, child_button)
                bot.send_message(call.message.chat.id, '''üìå –¢—ã –ø–ª–∞—Ç–∏–ª –∑–∞ —Å–µ–±—è –∏–ª–∏ –∑–∞ —Å–≤–æ–µ–≥–æ —Ä–µ–±–µ–Ω–∫–∞(–ø–æ–¥–ø–µ—á—ë–Ω–Ω–æ–≥–æ)?''', reply_markup=markup_education)
            if call.data == 'social_medicine':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå –ö–∞–∫–æ–π –≤–∏–¥ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –≤—ã—á–µ—Ç–∞ —É —Ç–µ–±—è?''',
                reply_markup=None)
                bot.send_message(call.message.chat.id, '''–í–≤–µ–¥–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —É—Å–ª—É–≥ –∏/–∏–ª–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤:''')
                bot.register_next_step_handler(call.message, get_last_cost)
            if call.data == 'social_insurance':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå –ö–∞–∫–æ–π –≤–∏–¥ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –≤—ã—á–µ—Ç–∞ —É —Ç–µ–±—è?''',
                reply_markup=None)
                bot.send_message(call.message.chat.id, '''üìå –°–∫–æ–ª—å–∫–æ —Ç—ã –∑–∞–ø–ª–∞—Ç–∏–ª –∑–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∫—É –≤ —ç—Ç–æ–º –≥–æ–¥—É?''')
                bot.register_next_step_handler(call.message, get_last_cost)
            if call.data == 'social_qualification':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå –ö–∞–∫–æ–π –≤–∏–¥ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –≤—ã—á–µ—Ç–∞ —É —Ç–µ–±—è?''',
                reply_markup=None)
                bot.send_message(call.message.chat.id, '''üìå –°–∫–æ–ª—å–∫–æ —Ç—ã –∑–∞–ø–ª–∞—Ç–∏–ª –∑–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—É—é –æ—Ü–µ–Ω–∫—É –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ —ç—Ç–æ–º –≥–æ–¥—É?''')
                bot.register_next_step_handler(call.message, get_last_cost)
            if call.data == 'social_education_own':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå –¢—ã –ø–ª–∞—Ç–∏–ª –∑–∞ —Å–µ–±—è –∏–ª–∏ –∑–∞ —Å–≤–æ–µ–≥–æ —Ä–µ–±–µ–Ω–∫–∞(–ø–æ–¥–ø–µ—á—ë–Ω–Ω–æ–≥–æ)? ''',
                reply_markup=None)
                bot.send_message(call.message.chat.id, '''–í–≤–µ–¥–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è:''')
                bot.register_next_step_handler(call.message, get_last_cost)
            if call.data == 'social_education_child':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå –¢—ã –ø–ª–∞—Ç–∏–ª –∑–∞ —Å–µ–±—è –∏–ª–∏ –∑–∞ —Å–≤–æ–µ–≥–æ —Ä–µ–±–µ–Ω–∫–∞(–ø–æ–¥–ø–µ—á—ë–Ω–Ω–æ–≥–æ)? ''',
                reply_markup=None)
                bot.send_message(call.message.chat.id, '''–í–≤–µ–¥–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è:''')
                bot.register_next_step_handler(call.message, get_child_education_price)
        
    except Exception as e:
        print(repr(e))
    return True

def get_last_charity(message):
    if not re.match(r'\d+$', message.text):
        bot.send_message(message.chat.id, '''–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã—Ö –¥–µ–Ω–µ–≥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: *–°—É–º–º–∞*''')
        bot.register_next_step_handler(message, get_last_charity)
    else:
        global last_income
        last_charity = int(message.text)
        final_income = 0.0325*last_income
        final_charity = 0.13*last_charity
        if final_income > final_charity:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(final_charity)}''')
        else:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(final_income)}''')

def get_last_cost(message):
    if not re.match(r'\d+$', message.text):
        bot.send_message(message.chat.id, '''–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã—Ö –¥–µ–Ω–µ–≥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: *–°—É–º–º–∞*''')
        bot.register_next_step_handler(message, get_last_cost)
    else:
        global last_income
        last_cost = int(message.text)
        final_income = 0.13*last_income
        final_cost = 0.13*last_cost
        if final_income > final_cost and final_cost < 15600:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(final_cost)}''')
        elif final_income <= final_cost and final_income < 15600:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(final_income)}''')
        else:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: 15600''')

def get_child_education_price(message):
    if not re.match(r'\d+$', message.text):
        bot.send_message(message.chat.id, '''–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã—Ö –¥–µ–Ω–µ–≥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: *–°—É–º–º–∞*''')
        bot.register_next_step_handler(message, get_child_education_price)
    else:
        global last_income
        last_education = int(message.text)
        final_income = 0.13*last_income
        final_education = 0.13*last_education
        if final_income > final_education and final_education < 6500:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(final_education)}''')
        elif final_income <= final_education and final_income < 6500:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(final_income)}''')
        else:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {6500}''')

@bot.callback_query_handler(func=lambda call: call.data.startswith('invest'))
def callback_inline(call):
    try:
        if call.message:
            if call.data == 'invest_a':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå –ö–∞–∫–æ–π —Ç–∏–ø –ª—å–≥–æ—Ç –ø–æ –ò–ò–° —É —Ç–µ–±—è?
                ''', reply_markup=None)
                bot.send_message(call.message.chat.id, '''üìå –°–∫–æ–ª—å–∫–æ –ª–µ—Ç —É —Ç–µ–±—è –æ—Ç–∫—Ä—ã—Ç –ò–ò–° (–º–∞–∫—Å–∏–º—É–º 3 –≥–æ–¥–∞)? ''')
                bot.register_next_step_handler(call.message, get_duration_invest_a)
            elif call.data == 'invest_b':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå –ö–∞–∫–æ–π —Ç–∏–ø –ª—å–≥–æ—Ç –ø–æ –ò–ò–° —É —Ç–µ–±—è?''',
                reply_markup=None)
                bot.send_message(call.message.chat.id, '''üìå –í–≤–µ–¥–∏ —Ä–∞–∑–º–µ—Ä –¥–æ—Ö–æ–¥–∞, –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∑–∞ 3 –≥–æ–¥–∞ —Å –ò–ò–° (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000,2000,3000)''')
                bot.register_next_step_handler(call.message, get_invest_b)
    except Exception as e:
        print(repr(e))
    return True

def get_invest_b(message):
    if not re.match(r'\d+,\d+,\d+$', message.text):
        bot.send_message(message.chat.id, '''–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ —Ä–∞–∑–º–µ—Ä –¥–æ—Ö–æ–¥–∞, –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∑–∞ 3 –≥–æ–¥–∞ —Å –ò–ò–° –≤ —Ñ–æ—Ä–º–∞—Ç–µ: *–î–æ—Ö–æ–¥ –∑–∞ –ø–µ—Ä–≤—ã–π –≥–æ–¥*,*–î–æ—Ö–æ–¥ –∑–∞ –≤—Ç–æ—Ä–æ–π –≥–æ–¥*,*–î–æ—Ö–æ–¥ –∑–∞ —Ç—Ä–µ—Ç–∏–π –≥–æ–¥*''')
        bot.register_next_step_handler(message, get_invest_b)
    else:
        incomes = message.text.split(',')
        bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(sum([int(x) for x in incomes])*0.13)}''')

def get_duration_invest_a(message):
    if not re.match(r'\d+$', message.text) or int(message.text) < 1:
        bot.send_message(message.chat.id, '''–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–µ—Ç, –≤ —Ç–µ—á–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä—ã—Ö —É —Ç–µ–±—è –æ—Ç–∫—Ä—ã—Ç –ò–ò–° –≤ —Ñ–æ—Ä–º–∞—Ç–µ: *–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–µ—Ç*''')
        bot.register_next_step_handler(message, get_duration_invest_a)
    else:
        global invest_duration
        invest_duration = 3 if int(message.text) > 3 else int(message.text)
        bot.send_message(message.chat.id, '''üìå –í–≤–µ–¥–∏ —Ä–∞–∑–º–µ—Ä—ã –≤–∑–Ω–æ—Å–æ–≤ –Ω–∞ –ò–°–° (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000,2000,3000)''')
        bot.register_next_step_handler(message, get_invest_a)

def get_invest_a(message):
    global invest_duration
    if not re.match(r'^\d+(?:,\d+){0,2}$', message.text) or message.text.count(',') != invest_duration - 1:
        bot.send_message(message.chat.id, '''–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ —Ä–∞–∑–º–µ—Ä—ã –≤–∑–Ω–æ—Å–æ–≤ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–µ—Ç —Å –ò–ò–° –≤ —Ñ–æ—Ä–º–∞—Ç–µ: *–í–∑–Ω–æ—Å –∑–∞ –ø–µ—Ä–≤—ã–π –≥–æ–¥*,*–í–∑–Ω–æ—Å –∑–∞ –≤—Ç–æ—Ä–æ–π –≥–æ–¥*,*–í–∑–Ω–æ—Å –∑–∞ —Ç—Ä–µ—Ç–∏–π –≥–æ–¥*''')
        bot.register_next_step_handler(message, get_invest_a)
    else:
        incomes = message.text.split(',')
        global last_income
        final_income = 0.13*last_income
        total_invest = 0
        for i in range(invest_duration):
            final_invest = 0.13*int(incomes[i])
            if final_income > final_invest and final_invest < 52000:
                total_invest += final_invest
            elif final_income <= final_invest and final_income < 52000:
                total_invest += final_income
            else:
                total_invest += 52000
        bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(total_invest)}''')

@bot.callback_query_handler(func=lambda call: call.data.startswith('invest'))
def callback_inline(call):
    try:
        if call.message:
            if call.data == 'invest_a':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå –ö–∞–∫–æ–π —Ç–∏–ø –ª—å–≥–æ—Ç –ø–æ –ò–ò–° —É —Ç–µ–±—è?
                ''', reply_markup=None)
                bot.send_message(call.message.chat.id, '''üìå –°–∫–æ–ª—å–∫–æ –ª–µ—Ç —É —Ç–µ–±—è –æ—Ç–∫—Ä—ã—Ç –ò–ò–° (–º–∞–∫—Å–∏–º—É–º 3 –≥–æ–¥–∞)? ''')
                bot.register_next_step_handler(call.message, get_duration_invest_a)
            elif call.data == 'invest_b':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå –ö–∞–∫–æ–π —Ç–∏–ø –ª—å–≥–æ—Ç –ø–æ –ò–ò–° —É —Ç–µ–±—è?''',
                reply_markup=None)
                bot.send_message(call.message.chat.id, '''üìå –í–≤–µ–¥–∏ —Ä–∞–∑–º–µ—Ä –¥–æ—Ö–æ–¥–∞, –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∑–∞ 3 –≥–æ–¥–∞ —Å –ò–ò–° (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000,2000,3000)''')
                bot.register_next_step_handler(call.message, get_invest_b)
    except Exception as e:
        print(repr(e))
    return True

def get_property_cost(message):
    if not re.match(r'\d+$', message.text):
        bot.send_message(message.chat.id, '''–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∂–∏–ª—å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ: *–°—Ç–æ–∏–º–æ—Å—Ç—å –∂–∏–ª—å—è*''')
        bot.register_next_step_handler(message, get_property_cost)
    else:
        global property_cost
        property_cost = int(message.text)
        markup_property = types.InlineKeyboardMarkup(row_width=2)
        prev_button = types.InlineKeyboardButton(f'{datetime.now().year - 1}', callback_data='property_prev_year')
        prev_prev_button = types.InlineKeyboardButton(f'{datetime.now().year - 2}', callback_data='property_prev_prev_year')
        prev_prev_prev_button = types.InlineKeyboardButton(f'{datetime.now().year - 3}', callback_data='property_prev_prev_prev_year')
        markup_property.add(prev_button, prev_prev_button, prev_prev_prev_button)
        bot.send_message(message.chat.id, '''üìå–í –∫–∞–∫–æ–º –≥–æ–¥—É —Ç—ã –∫—É–ø–∏–ª –∫–≤–∞—Ä—Ç–∏—Ä—É? ''', reply_markup=markup_property)

@bot.callback_query_handler(func=lambda call: call.data.startswith('property'))
def callback_inline(call):
    try:
        if call.message:
            if call.data == 'property_prev_year':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå–í –∫–∞–∫–æ–º –≥–æ–¥—É —Ç—ã –∫—É–ø–∏–ª –∫–≤–∞—Ä—Ç–∏—Ä—É? 
                ''', reply_markup=None)
                global last_income
                global property_cost
                final_income = 0.13*last_income
                final_property = 0.13*property_cost
                if final_income > final_property and final_property < 260000:
                    bot.send_message(call.message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(final_property)}''')
                elif final_income <= final_property and final_income < 260000:
                    bot.send_message(call.message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(final_income)}''')
                else:
                    bot.send_message(call.message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {260000}''')
            elif call.data == 'property_prev_prev_year':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå–í –∫–∞–∫–æ–º –≥–æ–¥—É —Ç—ã –∫—É–ø–∏–ª –∫–≤–∞—Ä—Ç–∏—Ä—É? ''',
                reply_markup=None)
                bot.send_message(call.message.chat.id, f'''üìå –í–≤–µ–¥–∏ —Å–≤–æ–π –¥–æ—Ö–æ–¥ –∑–∞ {datetime.now().year - 2} –≥–æ–¥: ''')
                bot.register_next_step_handler(call.message, get_prev_prev_income)
            elif call.data == 'property_prev_prev_prev_year':
                bot.edit_message_text(chat_id=call.message.chat.id, message_id=call.message.message_id, text='''üìå–í –∫–∞–∫–æ–º –≥–æ–¥—É —Ç—ã –∫—É–ø–∏–ª –∫–≤–∞—Ä—Ç–∏—Ä—É? ''',
                reply_markup=None)
                bot.send_message(call.message.chat.id, f'''üìå –í–≤–µ–¥–∏ —Å–≤–æ–π –¥–æ—Ö–æ–¥ –∑–∞ {datetime.now().year - 2} –∏ {datetime.now().year - 3} –≥–æ–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000, 2000): ''')
                bot.register_next_step_handler(call.message, get_prev_prev_prev_income)
    except Exception as e:
        print(repr(e))
    return True

def get_prev_prev_income(message):
    if not re.match(r'\d+$', message.text):
        bot.send_message(message.chat.id, f'''–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ —Å–≤–æ–π –¥–æ—Ö–æ–¥ –∑–∞ {datetime.now().year - 2} –≥–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: *–î–æ—Ö–æ–¥*''')
        bot.register_next_step_handler(message, get_prev_prev_income)
    else:
        global last_income
        global property_cost
        final_property = 0.13*property_cost
        final_income = 0.13*(last_income + int(message.text))
        if final_income > final_property and final_property < 260000:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(final_property)}''')
        elif final_income <= final_property and final_income < 260000:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(final_income)}''')
        else:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {260000}''')

def get_prev_prev_prev_income(message):
    if not re.match(r'\d+,\d+$', message.text):
        bot.send_message(message.chat.id, f'''–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ —Å–≤–æ–π –¥–æ—Ö–æ–¥ –∑–∞ {datetime.now().year - 2} –≥–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: *–î–æ—Ö–æ–¥ –∑–∞ {datetime.now().year - 2} –≥–æ–¥*,*–î–æ—Ö–æ–¥ –∑–∞ {datetime.now().year - 3} –≥–æ–¥*''')
        bot.register_next_step_handler(message, get_prev_prev_prev_income)
    else:
        global last_income
        global property_cost
        final_property = 0.13*property_cost
        incomes = message.text.split(',')
        final_income = 0.13*(sum([int(x) for x in incomes]) + last_income)
        if final_income > final_property and final_property < 260000:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(final_property)}''')
        elif final_income <= final_property and final_income < 260000:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {int(final_income)}''')
        else:
            bot.send_message(message.chat.id, f'''–†–∞–∑–º–µ—Ä –≤—ã—á–µ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å: {260000}''')



@bot.message_handler(content_types=['text'])
def undefined_input(message):
    bot.send_message(message.chat.id, telegram_config.IDK)

# RUN
bot.polling(none_stop=True)
